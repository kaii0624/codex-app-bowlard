<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Smile Overlay</title>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #app {
      position: fixed;
      inset: 0;
      overflow: hidden;
      background: #000;
    }

    #video,
    #overlay {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #overlay {
      pointer-events: none;
    }

    #status {
      position: absolute;
      left: 10px;
      bottom: 10px;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.72);
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(4px);
    }

    #error {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.75);
    }
  </style>
</head>
<body>
  <main id="app">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
    <div id="status">-</div>
    <div id="error">camera unavailable</div>
  </main>

  <script>
    (() => {
      const SAMPLE_INTERVAL_MS = 333;
      const SAMPLE_WIDTH = 320;

      const video = document.getElementById("video");
      const overlay = document.getElementById("overlay");
      const status = document.getElementById("status");
      const errorBox = document.getElementById("error");
      const overlayCtx = overlay.getContext("2d");

      const sampleCanvas = document.createElement("canvas");
      const sampleCtx = sampleCanvas.getContext("2d");
      sampleCanvas.width = SAMPLE_WIDTH;
      sampleCanvas.height = Math.round(SAMPLE_WIDTH * 0.75);

      let latest = { smile: false, score: 0.0, hasFace: false };
      let inFlight = false;

      function resizeOverlay() {
        overlay.width = video.clientWidth;
        overlay.height = video.clientHeight;
        drawOverlay();
      }

      function drawOverlay() {
        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
        status.textContent = latest.hasFace ? `face ${latest.score.toFixed(2)}` : "no face";

        if (!latest.smile) {
          return;
        }

        const textX = overlay.width / 2;
        const textY = overlay.height * 0.18;
        const fontSize = Math.max(54, Math.round(overlay.width * 0.16));

        overlayCtx.font = `700 ${fontSize}px -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", sans-serif`;
        overlayCtx.textAlign = "center";
        overlayCtx.textBaseline = "middle";
        overlayCtx.lineWidth = Math.max(4, Math.round(fontSize * 0.08));
        overlayCtx.strokeStyle = "rgba(0, 0, 0, 0.55)";
        overlayCtx.fillStyle = "rgba(255, 232, 29, 0.95)";
        overlayCtx.strokeText("SMILE", textX, textY);
        overlayCtx.fillText("SMILE", textX, textY);
      }

      function frameToJpegBlob() {
        return new Promise((resolve) => {
          sampleCanvas.toBlob(resolve, "image/jpeg", 0.6);
        });
      }

      async function sendFrame() {
        if (inFlight || video.readyState < 2 || !sampleCtx) {
          return;
        }

        const sourceWidth = video.videoWidth;
        const sourceHeight = video.videoHeight;
        if (!sourceWidth || !sourceHeight) {
          return;
        }

        inFlight = true;

        try {
          sampleCanvas.height = Math.max(1, Math.round((sourceHeight / sourceWidth) * SAMPLE_WIDTH));
          sampleCtx.drawImage(video, 0, 0, SAMPLE_WIDTH, sampleCanvas.height);
          const blob = await frameToJpegBlob();

          if (!blob) {
            throw new Error("JPEG encode failed");
          }

          const response = await fetch("/infer", {
            method: "POST",
            headers: {
              "Content-Type": "image/jpeg"
            },
            body: blob
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const payload = await response.json();
          latest = {
            smile: Boolean(payload.smile),
            score: Number(payload.score) || 0.0,
            hasFace: Boolean(payload.hasFace)
          };
        } catch {
          latest = { smile: false, score: 0.0, hasFace: false };
        } finally {
          inFlight = false;
          drawOverlay();
        }
      }

      async function startCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: false,
            video: {
              facingMode: "user"
            }
          });

          video.srcObject = stream;
          await video.play();
          resizeOverlay();
          setInterval(sendFrame, SAMPLE_INTERVAL_MS);
        } catch {
          errorBox.style.display = "flex";
        }
      }

      window.addEventListener("resize", resizeOverlay);
      video.addEventListener("loadedmetadata", resizeOverlay);

      startCamera();
    })();
  </script>
</body>
</html>
